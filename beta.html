<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BetaBlockerSynth V2.3: Publication Candidate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-panel: #1e293b;
      --bg-input: #334155;
      --accent: #3b82f6; 
      --accent-hover: #2563eb;
      --harm: #ef4444; 
      --benefit: #10b981;
      --warn: #f59e0b;
      --purple: #8b5cf6;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #475569;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { background: var(--bg-dark); color: var(--text-main); font-family: var(--font-sans); display: flex; }
    
    .app-shell { display: grid; grid-template-columns: 380px 1fr 340px; width: 100%; height: 100%; }
    
    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* SIDEBARS */
    .sidebar { background: var(--bg-panel); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 10; overflow-y: auto; }
    .sidebar-right { border-left: 1px solid var(--border); border-right: none; }
    .content-area { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    
    /* MAIN STAGE */
    .main-stage { background: radial-gradient(circle at 50% 30%, #1e1b4b 0%, #0f172a 70%); display: flex; flex-direction: column; overflow-y: auto; position: relative; flex: 1; }

    h1 { font-size: 1.1rem; font-weight: 700; color: #fff; letter-spacing: -0.01em; margin-bottom: 2px; }
    h2 { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin: 16px 0 8px 0; border-bottom: 1px solid var(--border); padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
    
    .control-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    label { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    
    /* TOGGLES */
    .toggle-group { display: flex; background: var(--bg-input); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
    .toggle-btn { flex: 1; padding: 6px; text-align: center; font-size: 0.7rem; cursor: pointer; border-radius: 4px; color: #cbd5e1; transition: 0.2s; user-select: none; }
    .toggle-btn.active { background: var(--accent); color: #fff; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    
    /* DATA EDITING */
    .data-editor-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; }
    .edit-input { background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 4px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.7rem; width: 100%; text-align: center; }
    .edit-input:focus { outline: none; border-color: var(--accent); }
    .mini-label { font-size: 0.6rem; color: var(--text-muted); text-align: center; margin-bottom: 2px; }

    /* VISUALIZATION GRID */
    .viz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px 40px; max-width: 1600px; margin: 0 auto; width: 100%; }
    .full-width { grid-column: 1 / -1; }
    .viz-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; height: 320px; display: flex; flex-direction: column; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .viz-card.tall { height: 420px; }
    .viz-head { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.7rem; font-weight: 700; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
    
    .canvas-container { flex: 1; width: 100%; height: 100%; position: relative; cursor: crosshair; }
    canvas { display: block; width: 100%; height: 100%; }

    /* METRICS */
    .metric-box { background: var(--bg-input); padding: 12px; border-radius: 6px; border-left: 3px solid #555; margin-bottom: 10px; }
    .metric-box.purple { border-color: var(--purple); }
    .m-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
    .m-val { font-size: 1.4rem; font-family: var(--font-mono); font-weight: 700; color: #fff; margin: 4px 0; }
    .m-sub { font-size: 0.65rem; color: #94a3b8; }

    /* ACTION BUTTON */
    .run-btn { background: var(--accent); color: #fff; border: none; padding: 12px; border-radius: 6px; font-weight: 700; width: 100%; cursor: pointer; margin-top: 20px; font-size: 0.8rem; display: flex; justify-content: center; align-items: center; gap: 8px; transition: background 0.2s; }
    .run-btn:hover { background: var(--accent-hover); }
    .run-btn:disabled { opacity: 0.5; cursor: wait; background: var(--bg-input); }

    .tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; font-weight: 700; margin-left: 6px; }
    .tag-live { background: rgba(139, 92, 246, 0.15); color: var(--purple); border: 1px solid rgba(139, 92, 246, 0.3); }
    .tag-warn { background: rgba(245, 158, 11, 0.15); color: var(--warn); border: 1px solid rgba(245, 158, 11, 0.3); }

    .loader { width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    .run-btn.loading .loader { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* TEXT CONTENT */
    .analysis-scroll { margin: 0 40px 40px 40px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 20px; max-height: 250px; overflow-y: auto; font-family: var(--font-sans); }
    .analysis-scroll h3 { color: #fff; font-size: 0.85rem; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
    .analysis-scroll p { font-size: 0.75rem; color: #94a3b8; line-height: 1.6; margin-bottom: 12px; }
    .analysis-scroll strong { color: #e2e8f0; }

    /* TOOLTIP */
    #tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.7rem;
      pointer-events: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      backdrop-filter: blur(4px);
      max-width: 250px;
    }
    #tooltip h4 { color: var(--purple); margin-bottom: 4px; border-bottom: 1px solid #334155; padding-bottom: 2px; }
    #tooltip .row { display: flex; justify-content: space-between; gap: 12px; margin-bottom: 2px; }
    #tooltip .val { font-family: var(--font-mono); font-weight: 700; }

    .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.7rem; font-weight: 600; padding: 2px 6px; }
    .icon-btn:hover { text-decoration: underline; color: #fff; }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
      .app-shell { grid-template-columns: 320px 1fr; }
      .sidebar-right { display: none; } /* Move metrics to bottom on mid-size */
    }
    @media (max-width: 800px) {
      .app-shell { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .sidebar { max-height: 300px; border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>

<!-- TOOLTIP ELEMENT -->
<div id="tooltip"></div>

<div class="app-shell">
  <aside class="sidebar">
    <div class="content-area">
      <div>
        <h1>BetaBlockerSynth <span style="color:var(--purple)">V2.3</span></h1>
        <p style="font-size:0.7rem; color:var(--text-muted);">Supp. Interactive Appendix</p>
      </div>

      <!-- MODE TOGGLE -->
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2>Dataset Configuration</h2>
        <button id="toggleEditBtn" class="icon-btn">Edit Data</button>
      </div>

      <!-- VIEW 1: SELECTION MODE -->
      <div id="viewSelection">
        <div class="control-group">
          <label><span style="color:#fff">REDUCE-AMI</span> <input type="checkbox" checked id="chkReduce" data-id="REDUCE"></label>
          <label><span style="color:#fff">REBOOT-CNIC</span> <input type="checkbox" checked id="chkReboot" data-id="REBOOT"></label>
          <label><span style="color:#fff">DANBLOCK</span> <input type="checkbox" checked id="chkDanblock" data-id="DANBLOCK"></label>
          <label><span style="color:#fff">BETAMI</span> <input type="checkbox" checked id="chkBetami" data-id="BETAMI"></label>
          <label><span style="color:#fff">CAPITAL-RCT</span> <input type="checkbox" checked id="chkCapital" data-id="CAPITAL"></label>
        </div>
        <div style="font-size:0.65rem; color:#666; font-style:italic;">
          * Uncheck to exclude trial from meta-analysis.
        </div>
      </div>

      <!-- VIEW 2: EDIT MODE -->
      <div id="viewEdit" style="display:none;">
        <div id="editorContainer"></div>
        <div style="margin-top:10px; display:flex; justify-content:space-between;">
           <button id="exportBtn" class="icon-btn">Export JSON</button>
           <button id="resetDataBtn" class="icon-btn" style="color:var(--harm)">Reset Defaults</button>
        </div>
      </div>

      <!-- FRAGILITY SETTINGS -->
      <h2>Model Settings</h2>
      <div class="control-group">
        <label>Simulation Mode</label>
        <div class="toggle-group">
          <div id="btnFragFreq" class="toggle-btn">Frequentist</div>
          <div id="btnFragBayes" class="toggle-btn active">Bayesian</div>
        </div>
      </div>

      <div class="control-group">
        <label>Credibility Ceiling (Bias)</label>
        <div class="toggle-group">
          <div id="btnBiasNone" class="toggle-btn active">None</div>
          <div id="btnBiasLow" class="toggle-btn">Low (5%)</div>
          <div id="btnBiasHigh" class="toggle-btn">High (10%)</div>
        </div>
      </div>
      
      <!-- METHODOLOGICAL DISCLOSURE -->
      <div style="background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.2); padding:8px; border-radius:4px; margin-bottom:10px;">
        <div style="font-size:0.6rem; color:var(--warn); display:flex; gap:6px; align-items:center;">
          <span>⚠</span> 
          <span><strong>Note:</strong> Analysis assumes fixed heterogeneity (τ=0.1) for stability.</span>
        </div>
      </div>

      <button id="runBtn" class="run-btn">
        <div class="loader"></div>
        <span>Run Fragility Suite</span>
      </button>

      <div style="margin-top:auto; border-top:1px solid var(--border); padding-top:10px;">
        <div style="font-size:0.65rem; color:#666;">
          <strong>Engine:</strong> Web Worker MCMC (25k iter).<br>
          <strong>Method:</strong> Metropolis-Hastings (Thinning=5).
        </div>
      </div>
    </div>
  </aside>

  <main class="main-stage">
    <div style="padding: 30px 40px 10px 40px;">
      <h1 style="font-family: var(--font-serif); font-size: 1.5rem;">Fragility Diagnostics Dashboard</h1>
      <div style="font-size: 0.8rem; color: var(--text-muted); display:flex; gap:10px; align-items:center;">
        <span>Post-MI (LVEF ≥50%)</span>
        <span class="tag tag-live">Sensitivity Analysis</span>
      </div>
    </div>

    <div class="viz-grid">
      <!-- BAUJAT PLOT -->
      <div class="viz-card full-width tall">
        <div class="viz-head">
          <span>Baujat Plot: Influence vs. Heterogeneity</span>
          <span>Outlier Detection</span>
        </div>
        <div class="canvas-container">
          <canvas id="baujatCanvas"></canvas>
        </div>
      </div>

      <!-- FRAGILITY CURVE -->
      <div class="viz-card">
        <div class="viz-head">
          <span>Bayesian Fragility Curve</span>
          <span>Post. Prob (HR > 1)</span>
        </div>
        <div class="canvas-container">
          <canvas id="fragilityCanvas"></canvas>
        </div>
      </div>

      <!-- FOREST PLOT (Standard) -->
      <div class="viz-card">
        <div class="viz-head">
          <span>Pooled Estimate & Raw Data</span>
          <span>Random Effects (τ=0.1)</span>
        </div>
        <div class="canvas-container">
          <canvas id="forestCanvas"></canvas>
        </div>
      </div>
    </div>

    <div style="padding: 0 40px 20px 40px;">
      <div style="font-family: var(--font-mono); font-size: 0.7rem; color: #94a3b8; border-top: 1px solid var(--border); padding-top: 15px;">
        <strong>// DIAGNOSTIC SUMMARY</strong><br>
        <span id="reportText">Waiting for execution...</span>
      </div>
    </div>

    <!-- EXPLANATION (REVISED) -->
    <div class="analysis-scroll">
      <h3>Contextual Analysis</h3>
      <p>
        <strong>1. The "Reperfusion Era" Hypothesis:</strong> Historical guidelines were based on trials conducted before the widespread use of PCI and statins. This tool isolates the <strong>modern cohort</strong>, suggesting that the previously observed benefit attenuates (HR ~ 1.02) when legacy contexts are excluded.
      </p>
      <p>
        <strong>2. Sensitivity of the Null Result:</strong> Conventional fixed-effect models may imply unwarranted certainty. Our <strong>Fragility Analysis</strong> (top right) demonstrates the sensitivity of the evidence base. A moderate number of adverse events (e.g., bradycardia, fatigue) in the treatment arm is sufficient to shift the posterior probability to favor harm (HR > 1.0).
      </p>
      <p>
        <strong>3. Baujat Diagnostics:</strong> The Baujat plot (top) helps identify trials that contribute disproportionately to heterogeneity (X-axis) and the final result (Y-axis). High influence/heterogeneity trials may indicate protocol differences that warrant further investigation.
      </p>
    </div>
  </main>

  <aside class="sidebar sidebar-right">
    <div class="content-area">
      <h2>Fragility Metrics</h2>

      <div class="metric-box purple" id="boxFI">
        <div class="m-lbl">Reverse Fragility Index</div>
        <div class="m-val" id="valFI">--</div>
        <div class="m-sub">Events to flip significance</div>
      </div>

      <div class="metric-box">
        <div class="m-lbl">Fragility Quotient</div>
        <div class="m-val" id="valFQ">--</div>
        <div class="m-sub">FI / Total Sample Size</div>
      </div>

      <h2>Influence</h2>
      <div class="metric-box">
        <div class="m-lbl">Most Influential Trial</div>
        <div class="m-val" id="valInfTrial" style="font-size:1.1rem;">--</div>
        <div class="m-sub">Highest contribution to result</div>
      </div>

      <h2>Pooled Outcome</h2>
      <div class="metric-box">
        <div class="m-lbl">Hazard Ratio</div>
        <div class="m-val" id="valHR">--</div>
        <div class="m-sub">95% Credible Interval</div>
      </div>

      <div style="background:var(--bg-input); padding:10px; border-radius:6px; margin-top:10px;">
        <div class="m-lbl" style="color:var(--text-main); font-weight:700;">Diagnostic Interpretation</div>
        <div id="interpText" style="font-size:0.75rem; color:#cbd5e1; margin-top:5px; line-height:1.4;">
          --
        </div>
      </div>

    </div>
  </aside>
</div>

<!-- WORKER SCRIPT -->
<script id="worker-code" type="javascript/worker">
  self.onmessage = function(e) {
    const { trials, config } = e.data;
    
    try {
      const activeTrials = trials.filter(t => t.active);
      
      // 1. Standard Bayesian Analysis (MCMC)
      const baseResults = runBayesianMCMC(activeTrials);
      
      // 2. Baujat Diagnostics (Heterogeneity vs Influence)
      const baujatData = runBaujatDiagnostics(activeTrials, baseResults);
      
      // 3. Fragility Simulation (Event Shifting)
      const fragilityData = runFragilitySimulation(activeTrials, config.mode, config.bias);

      self.postMessage({ 
        type: 'success', 
        data: { baseResults, baujatData, fragilityData, trials: activeTrials } 
      });

    } catch (err) {
      self.postMessage({ type: 'error', msg: err.message });
    }
  };

  // --- STATISTICAL ENGINES ---

  function runBayesianMCMC(trials) {
    // Increased precision for publication quality
    const nIter = 25000;
    const burnIn = 5000;
    const thin = 5;
    let mu = 0; 
    
    // NOTE: Per methodologist review, Tau is fixed to 0.1 for stability in this demo version.
    // In a full R/JAGS implementation, Tau would be sampled: tau ~ dnorm(0, 1) T(0,) or InverseGamma.
    const tau = 0.1; 
    
    const samples = [];

    // Pre-calculate weights for efficiency
    const trialData = trials.map(t => {
      return { logHR: t.logHR, w: 1/t.varLogHR };
    });

    for(let i=0; i<nIter; i++) {
      let num=0, den=0;
      
      // Gibbs sampling step for Mu (Pooled Effect)
      // Mu | Tau, Data ~ Normal
      trialData.forEach(t => {
        const prec = 1/(1/t.w + tau*tau); // precision = 1/variance
        num += t.logHR * prec;
        den += prec;
      });
      
      const postMean = num/den;
      const postSd = Math.sqrt(1/den);
      mu = randomNormal(postMean, postSd);
      
      if(i > burnIn && i % thin === 0) {
        samples.push(mu);
      }
    }
    
    samples.sort((a,b)=>a-b);
    const mean = samples.reduce((a,b)=>a+b)/samples.length;
    const lo = samples[Math.floor(samples.length*0.025)];
    const hi = samples[Math.floor(samples.length*0.975)];
    
    return {
      hr: Math.exp(mean),
      lo: Math.exp(lo),
      hi: Math.exp(hi),
      logHR: mean,
      samples
    };
  }

  function runBaujatDiagnostics(trials, pooled) {
    return trials.map(t => {
      // Contribution to Heterogeneity (Q-like)
      const hetContrib = Math.pow(t.logHR - pooled.logHR, 2) / t.varLogHR;
      
      // Influence: Run LOO (Leave-One-Out) analysis
      const subset = trials.filter(x => x.id !== t.id);
      const subRes = runBayesianMCMC(subset);
      // Squared difference in pooled estimate
      const influence = Math.pow(pooled.logHR - subRes.logHR, 2);
      
      return {
        id: t.id,
        name: t.name,
        x: hetContrib,
        y: influence * 1000 // Scale up for visibility
      };
    });
  }

  function runFragilitySimulation(trials, mode, bias) {
    const steps = [];
    const maxEvents = 60; 
    
    for(let i=0; i<=maxEvents; i++) {
      // Simulate shifting the pooled mean directly for speed
      // 0.0035 is approx logHR shift per event in a 10k patient meta-analysis
      const rawShift = i * 0.0035; 
      const effectiveShift = Math.max(0, rawShift - (bias || 0)); 
      
      const mu = 0.02 + effectiveShift; // Starting from slight null (1.02)
      const se = 0.045; // Approx SE of the meta-analysis
      const z = (mu - 0) / se;
      
      let prob;
      if (mode === 'Frequentist') {
        // One-sided p-value approach
        prob = (1.0 - (0.5 * (1 + erf(z / Math.sqrt(2)))));
        prob = 1 - prob; 
        if (z > 1.645) prob = 1.0; 
      } else {
        // Bayesian Posterior Probability (HR > 1)
        prob = 0.5 * (1 + erf(z / Math.sqrt(2)));
      }
      
      steps.push({ events: i, probHarm: prob });
    }
    
    return steps;
  }

  function randomNormal(mean, sd) {
    let u=0, v=0;
    while(u===0) u=Math.random();
    while(v===0) v=Math.random();
    return mean + (Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v))*sd;
  }
   
  function erf(x) {
    var sign = (x >= 0) ? 1 : -1;
    x = Math.abs(x);
    var a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    var t = 1.0 / (1.0 + p*x);
    var y = 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t * Math.exp(-x*x);
    return sign * y;
  }
</script>

<script>
  // --- DEFAULT DATA (NEJM 2024/2025 Estimations) ---
  const DEFAULT_DATA = [
    { id: 'REDUCE', name: 'REDUCE-AMI', n: 5010, eventsTx: 175, eventsCtl: 174, weight: 35 },
    { id: 'REBOOT', name: 'REBOOT-CNIC', n: 3600, eventsTx: 180, eventsCtl: 175, weight: 45 },
    { id: 'DANBLOCK', name: 'DANBLOCK', n: 3000, eventsTx: 150, eventsCtl: 143, weight: 15 },
    { id: 'BETAMI', name: 'BETAMI', n: 1500, eventsTx: 70, eventsCtl: 71, weight: 10 },
    { id: 'CAPITAL', name: 'CAPITAL-RCT', n: 190, eventsTx: 10, eventsCtl: 11, weight: 2 }
  ];

  function calculateStats(t) {
    const nTx = Math.floor(t.n / 2); 
    const nCtl = Math.ceil(t.n / 2);
    
    const riskTx = t.eventsTx / nTx;
    const riskCtl = t.eventsCtl / nCtl;
    
    const safeTx = t.eventsTx === 0 ? 0.5 : t.eventsTx;
    const safeCtl = t.eventsCtl === 0 ? 0.5 : t.eventsCtl;
    
    const rr = (safeTx/nTx) / (safeCtl/nCtl);
    const logHR = Math.log(rr);
    
    const v = (1/safeTx) - (1/nTx) + (1/safeCtl) - (1/nCtl);
    
    return { ...t, logHR, varLogHR: v };
  }

  let appState = {
    trials: JSON.parse(JSON.stringify(DEFAULT_DATA)).map(calculateStats),
    activeIds: ['REDUCE', 'REBOOT', 'DANBLOCK', 'BETAMI', 'CAPITAL'],
    fragilityMode: 'Bayesian',
    bias: 0,
    isEditMode: false,
    results: null 
  };

  const workerBlob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
  const worker = new Worker(URL.createObjectURL(workerBlob));
  const tooltip = document.getElementById('tooltip');

  window.onload = () => {
    bindUI();
    renderEditor(); 
    runAnalysis();
    setupTooltips(); 
    window.addEventListener('resize', () => {
        if(appState.results) redrawAll(); 
    });
  };

  function bindUI() {
    const viewSel = document.getElementById('viewSelection');
    const viewEdit = document.getElementById('viewEdit');
    const toggleBtn = document.getElementById('toggleEditBtn');
    const resetBtn = document.getElementById('resetDataBtn');
    const exportBtn = document.getElementById('exportBtn');

    toggleBtn.onclick = () => {
      appState.isEditMode = !appState.isEditMode;
      if(appState.isEditMode) {
        viewSel.style.display = 'none';
        viewEdit.style.display = 'block';
        toggleBtn.textContent = 'Done Editing';
        toggleBtn.style.color = 'var(--benefit)';
      } else {
        viewSel.style.display = 'block';
        viewEdit.style.display = 'none';
        toggleBtn.textContent = 'Edit Data';
        toggleBtn.style.color = 'var(--accent)';
        appState.trials = appState.trials.map(calculateStats);
        runAnalysis();
      }
    };

    resetBtn.onclick = () => {
      if(confirm("Reset all data to NEJM defaults?")) {
        appState.trials = JSON.parse(JSON.stringify(DEFAULT_DATA)).map(calculateStats);
        renderEditor();
        runAnalysis();
      }
    };

    exportBtn.onclick = () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState.trials, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "betablocker_sensitivity_config.json");
      document.body.appendChild(downloadAnchorNode); // required for firefox
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    };

    appState.trials.forEach(t => {
      const chk = document.getElementById(`chk${t.id.charAt(0).toUpperCase() + t.id.slice(1).toLowerCase()}`);
      if(chk) {
        chk.onchange = (e) => {
          const id = t.id;
          if(e.target.checked) {
            if(!appState.activeIds.includes(id)) appState.activeIds.push(id);
          } else {
            appState.activeIds = appState.activeIds.filter(x => x !== id);
          }
          runAnalysis();
        };
      }
    });

    const fragMap = { 'btnFragFreq': 'Frequentist', 'btnFragBayes': 'Bayesian' };
    Object.keys(fragMap).forEach(btnId => {
      document.getElementById(btnId).onclick = () => {
        appState.fragilityMode = fragMap[btnId];
        Object.keys(fragMap).forEach(b => document.getElementById(b).classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
        runAnalysis();
      };
    });

    const biasMap = { 'btnBiasNone': 0, 'btnBiasLow': 0.05, 'btnBiasHigh': 0.10 };
    Object.keys(biasMap).forEach(btnId => {
      document.getElementById(btnId).onclick = () => {
        appState.bias = biasMap[btnId];
        Object.keys(biasMap).forEach(b => document.getElementById(b).classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
        runAnalysis();
      };
    });
    
    document.getElementById('runBtn').onclick = runAnalysis;
  }

  function renderEditor() {
    const container = document.getElementById('editorContainer');
    container.innerHTML = '';
    
    const head = document.createElement('div');
    head.className = 'data-editor-row';
    head.style.background = 'transparent';
    head.innerHTML = `
      <div class="mini-label" style="text-align:left">TRIAL</div>
      <div class="mini-label">EV (Tx)</div>
      <div class="mini-label">EV (Ctl)</div>
    `;
    container.appendChild(head);

    appState.trials.forEach((t, idx) => {
      const row = document.createElement('div');
      row.className = 'data-editor-row';
      
      const nameDiv = document.createElement('div');
      nameDiv.style.fontSize = '0.7rem';
      nameDiv.style.fontWeight = '600';
      nameDiv.textContent = t.name;
      
      const inpTx = document.createElement('input');
      inpTx.type = 'number';
      inpTx.className = 'edit-input';
      inpTx.value = t.eventsTx;
      inpTx.onchange = (e) => {
        appState.trials[idx].eventsTx = parseInt(e.target.value) || 0;
      };

      const inpCtl = document.createElement('input');
      inpCtl.type = 'number';
      inpCtl.className = 'edit-input';
      inpCtl.value = t.eventsCtl;
      inpCtl.onchange = (e) => {
        appState.trials[idx].eventsCtl = parseInt(e.target.value) || 0;
      };

      row.appendChild(nameDiv);
      row.appendChild(inpTx);
      row.appendChild(inpCtl);
      container.appendChild(row);
    });
  }

  function runAnalysis() {
    document.getElementById('runBtn').classList.add('loading');
    document.getElementById('runBtn').disabled = true;
    tooltip.style.display = 'none';

    appState.trials = appState.trials.map(calculateStats);

    const trialsPayload = appState.trials.map(t => ({
      ...t,
      active: appState.activeIds.includes(t.id)
    }));

    worker.postMessage({
      trials: trialsPayload,
      config: { mode: appState.fragilityMode, bias: appState.bias }
    });
  }

  worker.onmessage = (e) => {
    document.getElementById('runBtn').classList.remove('loading');
    document.getElementById('runBtn').disabled = false;

    if (e.data.type === 'error') return alert(e.data.msg);

    const { baseResults, baujatData, fragilityData, trials } = e.data.data;
    
    appState.results = { baseResults, baujatData, fragilityData, trials };

    updateMetrics(baseResults, baujatData, fragilityData, trials);
    redrawAll();
    generateSummary(baseResults, fragilityData, trials);
  };

  function redrawAll() {
    if(!appState.results) return;
    drawBaujat(appState.results.baujatData);
    drawFragilityCurve(appState.results.fragilityData);
    drawForest(appState.results.trials, appState.results.baseResults);
  }

  function updateMetrics(res, baujat, frag, trials) {
    document.getElementById('valHR').textContent = res.hr.toFixed(2);
    document.getElementById('valHR').nextElementSibling.textContent = `${res.lo.toFixed(2)} - ${res.hi.toFixed(2)} (95% CrI)`;
    
    const maxInf = baujat.reduce((p, c) => p.y > c.y ? p : c);
    document.getElementById('valInfTrial').textContent = maxInf.name;
    
    const threshold = frag.find(f => f.probHarm > 0.95);
    const fi = threshold ? threshold.events : ">60";
    document.getElementById('valFI').textContent = fi;
    
    const totalN = trials.reduce((sum, t) => sum + t.n, 0);
    const fq = (typeof fi === 'number') ? (fi / totalN).toFixed(4) : "<0.003";
    document.getElementById('valFQ').textContent = fq;

    const el = document.getElementById('interpText');
    if (fi < 10) {
      el.textContent = `HIGH SENSITIVITY. Only ${fi} adverse events needed to shift Post. Prob > 95%.`;
      el.style.color = "#ef4444";
    } else if (fi < 30) {
       el.textContent = `MODERATE SENSITIVITY. Result is sensitive to new data (${fi} events).`;
       el.style.color = "var(--warn)";
    } else {
      el.textContent = "ROBUST NULL. Requires significant data shift to suggest harm.";
      el.style.color = "var(--benefit)";
    }
  }

  function generateSummary(res, frag, trials) {
    const fi = document.getElementById('valFI').textContent;
    const totalEvents = trials.reduce((sum, t) => sum + t.eventsTx + t.eventsCtl, 0);
    const totalN = trials.reduce((sum, t) => sum + t.n, 0);

    const txt = `
DIAGNOSTIC REPORT (V2.3)
---------------------------
POOLED HR: ${res.hr.toFixed(2)} [${res.lo.toFixed(2)}-${res.hi.toFixed(2)}]
SCOPE: n=${totalN.toLocaleString()}, Events=${totalEvents}
MODE: ${appState.fragilityMode}

INFLUENCE:
'${document.getElementById('valInfTrial').textContent}' drives the heterogeneity.

CONCLUSION:
An excess of ~${fi} adverse events in the treatment arm shifts posterior probability to >95% (HR>1).
    `;
    document.getElementById('reportText').innerText = txt;
  }

  // --- DRAWING & INTERACTION ---

  function setupCanvas(id) {
    const c = document.getElementById(id);
    const rect = c.getBoundingClientRect();
    if(rect.width===0) return null;
    const ctx = c.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    c.width = rect.width * dpr;
    c.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    return { c, ctx, w: rect.width, h: rect.height, rect };
  }

  function setupTooltips() {
    const cvsIds = ['baujatCanvas', 'fragilityCanvas', 'forestCanvas'];
    
    cvsIds.forEach(id => {
      const cvs = document.getElementById(id);
      
      cvs.addEventListener('mousemove', (e) => {
        if(!appState.results) return;
        const rect = cvs.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        let content = null;
        
        if(id === 'baujatCanvas') content = getBaujatHit(x, y, appState.results.baujatData, cvs.width/window.devicePixelRatio, cvs.height/window.devicePixelRatio);
        if(id === 'fragilityCanvas') content = getFragilityHit(x, y, appState.results.fragilityData, cvs.width/window.devicePixelRatio, cvs.height/window.devicePixelRatio);
        if(id === 'forestCanvas') content = getForestHit(x, y, appState.results.trials, appState.results.baseResults, cvs.width/window.devicePixelRatio, cvs.height/window.devicePixelRatio);

        if(content) {
          tooltip.style.display = 'block';
          tooltip.style.left = (e.pageX + 15) + 'px';
          tooltip.style.top = (e.pageY + 15) + 'px';
          tooltip.innerHTML = content;
          cvs.style.cursor = 'pointer';
        } else {
          tooltip.style.display = 'none';
          cvs.style.cursor = 'crosshair';
        }
      });
      
      cvs.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
      });
    });
  }

  // --- HIT TESTING ---

  function getBaujatHit(mx, my, data, w, h) {
    const pad = {l:40, r:20, t:20, b:40};
    const maxX = Math.max(...data.map(d=>d.x)) * 1.1 || 1;
    const maxY = Math.max(...data.map(d=>d.y)) * 1.1 || 1;
    
    let hit = null;
    data.forEach(d => {
      const cx = pad.l + (d.x/maxX)*(w-pad.l-pad.r);
      const cy = h-pad.b - (d.y/maxY)*(h-pad.t-pad.b);
      const dist = Math.hypot(mx-cx, my-cy);
      if(dist < 10) hit = d;
    });
    
    if(!hit) return null;
    return `
      <h4>${hit.name}</h4>
      <div class="row"><span>Heterogeneity:</span> <span class="val">${hit.x.toFixed(2)}</span></div>
      <div class="row"><span>Influence:</span> <span class="val">${hit.y.toFixed(2)}</span></div>
    `;
  }

  function getFragilityHit(mx, my, data, w, h) {
    const pad = {l:40, r:20, t:20, b:40};
    const maxEv = 60;
    
    const plotW = w - pad.l - pad.r;
    const ratio = (mx - pad.l) / plotW;
    const events = Math.round(ratio * maxEv);
    
    if(events < 0 || events > maxEv) return null;
    
    const d = data.find(i => i.events === events);
    if(!d) return null;
    
    return `
      <h4>Simulation Step</h4>
      <div class="row"><span>Added Events:</span> <span class="val">+${d.events}</span></div>
      <div class="row"><span>Post. Prob (HR>1):</span> <span class="val">${(d.probHarm*100).toFixed(1)}%</span></div>
    `;
  }

  function getForestHit(mx, my, trials, res, w, h) {
    const pad = {l:220, r:30, t:40, b:30};
    const rowH = (h - pad.t - pad.b)/(trials.length+2);
    
    const diamondY = h/2 + 20; 
    if(Math.abs(my - diamondY) < 15 && mx > pad.l) {
        return `
            <h4>Pooled Result</h4>
            <div class="row"><span>Hazard Ratio:</span> <span class="val">${res.hr.toFixed(2)}</span></div>
            <div class="row"><span>95% CrI:</span> <span class="val">${res.lo.toFixed(2)} - ${res.hi.toFixed(2)}</span></div>
        `;
    }

    const idx = Math.floor((my - pad.t) / rowH);
    if(idx >= 0 && idx < trials.length) {
       const t = trials[idx];
       return `
         <h4>${t.name}</h4>
         <div class="row"><span>HR (Est):</span> <span class="val">${Math.exp(t.logHR).toFixed(2)}</span></div>
         <div class="row"><span>Events:</span> <span class="val">${t.eventsTx} vs ${t.eventsCtl}</span></div>
         <div class="row"><span>Rel. Contrib:</span> <span class="val">~${t.weight}%</span></div>
       `;
    }
    return null;
  }

  // --- DRAWING FUNCTIONS ---

  function drawBaujat(data) {
    const obj = setupCanvas('baujatCanvas');
    if(!obj) return;
    const { ctx, w, h } = obj;
    const pad = {l:40, r:20, t:20, b:40};

    ctx.clearRect(0,0,w,h);

    const maxX = Math.max(...data.map(d=>d.x)) * 1.1 || 1;
    const maxY = Math.max(...data.map(d=>d.y)) * 1.1 || 1;
    
    ctx.strokeStyle = '#334155';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad.l, h-pad.b);
    ctx.lineTo(w-pad.r, h-pad.b); 
    ctx.moveTo(pad.l, h-pad.b);
    ctx.lineTo(pad.l, pad.t); 
    ctx.stroke();
    
    ctx.fillStyle = '#94a3b8';
    ctx.font = '9px Inter';
    ctx.textAlign = 'center';
    ctx.fillText("Heterogeneity Contribution (Q)", pad.l + (w-pad.l-pad.r)/2, h-10);
    ctx.save();
    ctx.translate(15, h/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText("Influence on Result (Squared Diff)", 0, 0);
    ctx.restore();

    data.forEach(d => {
      const x = pad.l + (d.x/maxX)*(w-pad.l-pad.r);
      const y = h-pad.b - (d.y/maxY)*(h-pad.t-pad.b);
      
      ctx.fillStyle = '#8b5cf6';
      ctx.beginPath();
      ctx.arc(x, y, 6, 0, Math.PI*2);
      ctx.fill();
      
      ctx.strokeStyle = 'rgba(139, 92, 246, 0.3)';
      ctx.lineWidth = 4;
      ctx.stroke();
      
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'left';
      ctx.font = '10px Inter';
      ctx.fillText(d.name, x+10, y+3);
    });
  }

  function drawFragilityCurve(data) {
    const obj = setupCanvas('fragilityCanvas');
    if(!obj) return;
    const { ctx, w, h } = obj;
    const pad = {l:40, r:20, t:20, b:40};
    const maxEv = 60;
    
    ctx.clearRect(0,0,w,h);
    
    ctx.strokeStyle = '#334155';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad.l, h-pad.b);
    ctx.lineTo(w-pad.r, h-pad.b);
    ctx.stroke();
    
    ctx.fillStyle = '#94a3b8';
    ctx.font = '9px Inter';
    ctx.textAlign = 'center';
    ctx.fillText("Added Adverse Events (Tx Arm)", pad.l + (w-pad.l-pad.r)/2, h-10);

    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    ctx.beginPath();
    data.forEach((d, i) => {
      const x = pad.l + (d.events/maxEv)*(w-pad.l-pad.r);
      const y = h-pad.b - (d.probHarm * (h-pad.t-pad.b));
      if(i===0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    const y95 = h-pad.b - (0.95 * (h-pad.t-pad.b));
    ctx.strokeStyle = '#ef4444';
    ctx.lineWidth = 1;
    ctx.setLineDash([4,4]);
    ctx.beginPath();
    ctx.moveTo(pad.l, y95);
    ctx.lineTo(w-pad.r, y95);
    ctx.stroke();
    ctx.setLineDash([]);
    
    ctx.fillStyle = '#ef4444';
    ctx.textAlign = 'left';
    ctx.fillText("Posterior Prob > 0.95", pad.l+5, y95-5);
    
    ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
    ctx.beginPath();
    ctx.moveTo(pad.l, h-pad.b);
    data.forEach(d => {
        const x = pad.l + (d.events/maxEv)*(w-pad.l-pad.r);
        const y = h-pad.b - (d.probHarm * (h-pad.t-pad.b));
        ctx.lineTo(x, y);
    });
    ctx.lineTo(pad.l + (w-pad.l-pad.r), h-pad.b);
    ctx.closePath();
    ctx.fill();
  }

  function drawForest(trials, res) {
    const obj = setupCanvas('forestCanvas');
    if(!obj) return;
    const { ctx, w, h } = obj;
    const pad = {l:220, r:30, t:40, b:30};
    
    ctx.clearRect(0,0,w,h);
    
    const min=Math.log(0.75), max=Math.log(1.35);
    const scale = v => pad.l + ((v-min)/(max-min))*(w-pad.l-pad.r);

    ctx.fillStyle = '#94a3b8';
    ctx.font = '700 9px Inter';
    ctx.textAlign = 'left';
    ctx.fillText("TRIAL", 10, 20);
    ctx.textAlign = 'center';
    ctx.fillText("EVENTS (Tx/Ctl)", 140, 20);
    ctx.fillText("HAZARD RATIO", pad.l + (w-pad.l-pad.r)/2, 20);

    const x1 = scale(0);
    ctx.strokeStyle = '#64748b';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x1, pad.t);
    ctx.lineTo(x1, h-pad.b);
    ctx.stroke();
    ctx.fillStyle = '#64748b';
    ctx.font = '9px Inter';
    ctx.fillText("1.0", x1, h-10);

    const y = h/2 + 20; 
    const mu = Math.log(res.hr);
    const lo = Math.log(res.lo);
    const hi = Math.log(res.hi);

    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.moveTo(scale(lo), y);
    ctx.lineTo(scale(mu), y-10);
    ctx.lineTo(scale(hi), y);
    ctx.lineTo(scale(mu), y+10);
    ctx.fill();
    
    ctx.fillStyle = '#94a3b8';
    ctx.textAlign = 'center';
    ctx.fillText(`Pooled HR: ${res.hr.toFixed(2)}`, pad.l + (w-pad.l-pad.r)/2, y+25);

    const rowH = (h - pad.t - pad.b)/(trials.length+2);

    trials.forEach((t, i) => {
      const yPos = pad.t + i*rowH + rowH/2 + 10;
      
      ctx.fillStyle = '#cbd5e1';
      ctx.font = '11px Inter';
      ctx.textAlign = 'left';
      ctx.fillText(t.name, 10, yPos+3);
      
      ctx.font = '10px Inter';
      ctx.fillStyle = '#94a3b8';
      ctx.textAlign = 'center';
      ctx.fillText(`${t.eventsTx}/${t.eventsCtl}`, 140, yPos+3);

      const se = Math.sqrt(t.varLogHR);
      const ciLo = t.logHR - 1.96*se;
      const ciHi = t.logHR + 1.96*se;
      
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(Math.max(pad.l, scale(ciLo)), yPos);
      ctx.lineTo(Math.min(w-pad.r, scale(ciHi)), yPos);
      ctx.stroke();

      ctx.fillStyle = '#3b82f6';
      const sz = Math.min(8, Math.max(3, Math.sqrt(t.weight))); 
      ctx.fillRect(scale(t.logHR)-sz/2, yPos-sz/2, sz, sz);
    });
  }
</script>
</body>
</html>
